<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Socket App</title>
    <link href="/static/index.css" rel="stylesheet">
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.10.4/polyfill.min.js"></script>
  </head>
  <body>
    <div id="root">
      <div id="my_chat">
        <div class="viewer scroll-wrapper">
          <ul>
          </ul>
        </div>
        <div class="sender">
          <input type="text" name="message" id="message">
          <button id="submit">submit</button>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
      /**
       * Constant Variables
       */
       
      const SOCKET_CONNECT = 'connect';
      const SOCKET_CONNECT_ERROR = 'connect_error';
      const SOCKET_DISCONNECT = 'disconnect';
      const SOCKET_ERROR = 'error';
      
      const SOCKET_TIMEOUT = 60*1000;
      const SOCKET_RECONNECTION = false;
      const SOCKET_RECONNECT_DELAY = 5*1000;
      
      const EVENT_SEND_MESSAGE = 'send_message';
      const EVENT_RECV_MESSAGE = 'recv_message';
      
      const NAMESPACE_CHAT = '/chat';
      
    </script>
    <script type="text/javascript" charset="utf-8">
      /**
       * Socket.io
       * Life Cycle 
       **/
       
      // Create Socket Instance
      const socket = io(
        NAMESPACE_CHAT, {
          reconnection: SOCKET_RECONNECTION,
          timeout: SOCKET_TIMEOUT,
        }
      );
      
      // Connect
      socket.on(SOCKET_CONNECT, ( success, sid )=>{
        console.group(SOCKET_CONNECT);
        console.log(socket);
        console.log(success);
        console.log(sid);
        console.groupEnd(SOCKET_CONNECT);
      });
      
      // Custom Reconnect
      socket.on(SOCKET_CONNECT_ERROR, error => {
        console.group(SOCKET_CONNECT_ERROR);
        console.log(error);
        console.groupEnd(SOCKET_CONNECT_ERROR);
        // Do Reconnection
        setTimeout(() => {
          console.log("do reconnect");
          socket.connect();
        }, SOCKET_RECONNECT_DELAY);
      });

      // Error
      socket.on(SOCKET_ERROR, error => {
        console.group(SOCKET_ERROR);
        console.log(error);
        console.groupEnd(SOCKET_ERROR);
      });
      
      // Disconnect
      socket.on(SOCKET_DISCONNECT, () => {
        console.log(SOCKET_DISCONNECT, "bye...");
      });
  </script>
  <script type="text/javascript" charset="utf-8">
    /**
     * Socket.io
     * Event Handlers 
     **/
    const makeMessageItem = ( sid, message ) => {
      const viewer = document.querySelector("#my_chat > .viewer > ul");
      const listItem = document.createElement("li");
      
      listItem.appendChild(document.createTextNode(message));
      viewer.appendChild(listItem);
    }
  
    /* Socket Event: Receive Message */
    socket.on(EVENT_RECV_MESSAGE, ({ sid, message }) => {
      console.group(EVENT_RECV_MESSAGE);
      console.log(sid);
      console.log(message);
      console.groupEnd(EVENT_RECV_MESSAGE);
      
      makeMessageItem( sid, message );
    });
    
    /* Handler Submit */
    const submit = document.querySelector("#submit");
    const handleSendMessage = event => {
      event.preventDefault();
      
      const message = document.querySelector("#message");
      
      /* Socket Event: Send Message */
      socket.emit(EVENT_SEND_MESSAGE, message.value, (success, retval) => {
        console.group(EVENT_SEND_MESSAGE);
        console.log(success);
        console.log(retval);
        console.groupEnd(EVENT_SEND_MESSAGE);
        
        message.value = "";
      });
    }
    submit.removeEventListener('click', handleSendMessage, false);
    submit.addEventListener('click', handleSendMessage, false);
    
    /* Handler KeyDown */
    const message = document.querySelector("#message");
    const handleEnter = event => {
      if( event.key === "Enter" || event.keyCode === 13 ){
        handleSendMessage( event );
      }
    }
    message.removeEventListener('keydown', handleEnter, false);
    message.addEventListener('keydown', handleEnter, false);
    
  </script>
  </body>
</html>